<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - ‡∏ï‡∏£‡∏ß‡∏à‡∏á‡∏≤‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡∏°.5</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Sarabun', 'Segoe UI', Tahoma, sans-serif; background: #f0f2f5; min-height: 100vh; }

        /* Login */
        .login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); z-index: 1000; display: flex; align-items: center; justify-content: center; }
        .login-box { background: white; border-radius: 20px; padding: 40px 30px; max-width: 400px; width: 90%; text-align: center; }
        .login-box h2 { color: #764ba2; margin-bottom: 20px; }
        .login-box input { width: 100%; padding: 12px 16px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1rem; margin-bottom: 14px; }
        .login-box input:focus { border-color: #764ba2; outline: none; }
        .login-btn { background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 12px; width: 100%; border-radius: 10px; font-size: 1.1rem; cursor: pointer; }
        .login-error { color: #f5576c; margin-top: 10px; display: none; }

        /* Header */
        .header { background: white; padding: 16px 24px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px; }
        .header h1 { color: #764ba2; font-size: 1.3rem; }
        .header-actions { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }

        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }

        /* Filters */
        .filters { background: white; border-radius: 14px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.06); display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
        .filters select, .filters input { padding: 10px 14px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 0.95rem; }
        .filters select:focus, .filters input:focus { border-color: #764ba2; outline: none; }
        .filter-btn { background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 10px 20px; border-radius: 10px; cursor: pointer; font-size: 0.95rem; }
        .refresh-btn { background: #43e97b; color: white; border: none; padding: 10px 20px; border-radius: 10px; cursor: pointer; font-size: 0.95rem; }

        /* Stats */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 14px; margin-bottom: 20px; }
        .stat-card { background: white; border-radius: 14px; padding: 20px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.06); }
        .stat-card .num { font-size: 2rem; font-weight: 800; color: #764ba2; }
        .stat-card .label { color: #888; font-size: 0.85rem; margin-top: 4px; }

        /* Tabs */
        .tabs { display: flex; gap: 6px; margin-bottom: 20px; flex-wrap: wrap; }
        .tab { padding: 10px 18px; background: white; border: 2px solid #e0e0e0; border-radius: 10px; cursor: pointer; font-size: 0.9rem; color: #555; transition: all 0.2s; }
        .tab.active { background: #764ba2; color: white; border-color: #764ba2; }

        /* Table */
        .table-wrap { background: white; border-radius: 14px; box-shadow: 0 2px 10px rgba(0,0,0,0.06); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th { background: #f8f4ff; color: #764ba2; padding: 14px 16px; text-align: left; font-size: 0.9rem; border-bottom: 2px solid #e8e0f0; white-space: nowrap; }
        td { padding: 12px 16px; border-bottom: 1px solid #f0f0f0; font-size: 0.9rem; color: #444; }
        tr:hover { background: #faf8ff; }
        .score-badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-weight: 600; font-size: 0.85rem; }
        .score-high { background: #e8fdf0; color: #2d8a56; }
        .score-mid { background: #fff8e1; color: #f57f17; }
        .score-low { background: #fde8eb; color: #c0392b; }
        .answer-cell { max-width: 300px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: pointer; }
        .answer-cell:hover { white-space: normal; overflow: visible; background: #f8f4ff; }

        /* Empty */
        .empty-state { text-align: center; padding: 60px 20px; color: #aaa; }
        .empty-state .icon { font-size: 3rem; margin-bottom: 10px; }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 500; display: none; align-items: center; justify-content: center; }
        .modal-overlay.active { display: flex; }
        .modal-box { background: white; border-radius: 16px; padding: 30px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; }
        .modal-box h3 { color: #764ba2; margin-bottom: 14px; }
        .modal-box p { color: #444; line-height: 1.8; margin-bottom: 10px; }
        .modal-close { background: #eee; border: none; padding: 8px 20px; border-radius: 8px; cursor: pointer; margin-top: 14px; }

        /* Export */
        .export-btn { background: #4facfe; color: white; border: none; padding: 10px 20px; border-radius: 10px; cursor: pointer; font-size: 0.9rem; }

        /* Check button */
        .check-btn { border: none; padding: 6px 14px; border-radius: 8px; cursor: pointer; font-size: 0.85rem; font-weight: 600; transition: all 0.2s; }
        .check-btn.unchecked { background: #f0f0f0; color: #999; }
        .check-btn.unchecked:hover { background: #e0e0e0; }
        .check-btn.checked { background: #43e97b; color: white; }
        .check-btn.checked:hover { background: #38d46c; }

        @media (max-width: 768px) {
            .header { flex-direction: column; align-items: flex-start; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .filters { flex-direction: column; }
            .filters select, .filters input { width: 100%; }
        }
    </style>
</head>
<body>

<!-- Login -->
<div class="login-overlay" id="loginOverlay">
    <div class="login-box">
        <h2>üîê ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö Admin</h2>
        <p style="color:#888;margin-bottom:20px;">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏π‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</p>
        <input type="password" id="adminPassword" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" onkeypress="if(event.key==='Enter')adminLogin()">
        <button class="login-btn" onclick="adminLogin()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        <p class="login-error" id="loginError">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</p>
    </div>
</div>

<!-- Header -->
<div class="header" id="mainHeader" style="display:none;">
    <h1>üìä Admin - ‡∏ï‡∏£‡∏ß‡∏à‡∏á‡∏≤‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡∏°.5</h1>
    <div class="header-actions">
        <button class="export-btn" onclick="exportCSV()">üì• Export CSV</button>
        <button class="refresh-btn" onclick="loadData()">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
        <button onclick="logout()" style="background:#f5576c;color:white;border:none;padding:10px 16px;border-radius:10px;cursor:pointer;">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>
</div>

<div class="container" id="mainContent" style="display:none;">

    <!-- Stats -->
    <div class="stats-grid" id="statsGrid">
        <div class="stat-card"><div class="num" id="totalSubmissions">0</div><div class="label">‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div></div>
        <div class="stat-card"><div class="num" id="totalNotebook">0</div><div class="label">‡∏á‡∏≤‡∏ô‡∏™‡∏°‡∏∏‡∏î</div></div>
        <div class="stat-card"><div class="num" id="totalQuiz">0</div><div class="label">‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö</div></div>
        <div class="stat-card"><div class="num" id="totalMessage">0</div><div class="label">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</div></div>
        <div class="stat-card"><div class="num" id="totalChecked" style="color:#43e97b;">0</div><div class="label">‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß</div></div>
    </div>

    <!-- Filters -->
    <div class="filters">
        <select id="filterClass">
            <option value="">‡∏ó‡∏∏‡∏Å‡∏´‡πâ‡∏≠‡∏á</option>
            <option value="‡∏°.5/1">‡∏°.5/1</option>
            <option value="‡∏°.5/2">‡∏°.5/2</option>
            <option value="‡∏°.5/3">‡∏°.5/3</option>
            <option value="‡∏°.5/4">‡∏°.5/4</option>
            <option value="‡∏°.5/5">‡∏°.5/5</option>
            <option value="‡∏°.5/6">‡∏°.5/6</option>
            <option value="‡∏°.5/7">‡∏°.5/7</option>
            <option value="‡∏°.5/8">‡∏°.5/8</option>
            <option value="‡∏°.5/9">‡∏°.5/9</option>
        </select>
        <select id="filterType">
            <option value="">‡∏ó‡∏∏‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</option>
            <option value="notebook1">‡∏á‡∏≤‡∏ô‡∏™‡∏°‡∏∏‡∏î 1</option>
            <option value="notebook2">‡∏á‡∏≤‡∏ô‡∏™‡∏°‡∏∏‡∏î 2</option>
            <option value="notebook3">‡∏á‡∏≤‡∏ô‡∏™‡∏°‡∏∏‡∏î 3</option>
            <option value="quiz1">‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö ‡∏ö‡∏ó‡∏ó‡∏µ‡πà 1</option>
            <option value="quiz2">‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö ‡∏ö‡∏ó‡∏ó‡∏µ‡πà 2</option>
            <option value="quiz3">‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö ‡∏ö‡∏ó‡∏ó‡∏µ‡πà 3</option>
            <option value="message">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏∂‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏π</option>
        </select>
        <input type="text" id="filterName" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠...">
        <button class="filter-btn" onclick="applyFilters()">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
    </div>

    <!-- Tabs -->
    <div class="tabs" id="classTabs">
        <div class="tab active" onclick="switchClassTab('')">‡∏ó‡∏∏‡∏Å‡∏´‡πâ‡∏≠‡∏á</div>
        <div class="tab" onclick="switchClassTab('‡∏°.5/1')">‡∏°.5/1</div>
        <div class="tab" onclick="switchClassTab('‡∏°.5/2')">‡∏°.5/2</div>
        <div class="tab" onclick="switchClassTab('‡∏°.5/3')">‡∏°.5/3</div>
        <div class="tab" onclick="switchClassTab('‡∏°.5/4')">‡∏°.5/4</div>
        <div class="tab" onclick="switchClassTab('‡∏°.5/5')">‡∏°.5/5</div>
        <div class="tab" onclick="switchClassTab('‡∏°.5/6')">‡∏°.5/6</div>
        <div class="tab" onclick="switchClassTab('‡∏°.5/7')">‡∏°.5/7</div>
        <div class="tab" onclick="switchClassTab('‡∏°.5/8')">‡∏°.5/8</div>
        <div class="tab" onclick="switchClassTab('‡∏°.5/9')">‡∏°.5/9</div>
    </div>

    <!-- Table -->
    <div class="table-wrap">
        <table>
            <thead>
                <tr>
                    <th>#</th>
                    <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                    <th>‡∏´‡πâ‡∏≠‡∏á</th>
                    <th>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th>
                    <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô</th>
                    <th>‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö / ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th>
                    <th>‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡πà‡∏á</th>
                    <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                </tr>
            </thead>
            <tbody id="dataTable">
            </tbody>
        </table>
    </div>
    <div class="empty-state" id="emptyState" style="display:none;">
        <div class="icon">üì≠</div>
        <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
    </div>
</div>

<!-- Answer Modal -->
<div class="modal-overlay" id="answerModal">
    <div class="modal-box">
        <h3 id="modalTitle">‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</h3>
        <p id="modalBody"></p>
        <button class="modal-close" onclick="closeModal()">‡∏õ‡∏¥‡∏î</button>
    </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

<script>
// Firebase
const firebaseConfig = {
    apiKey: "AIzaSyDE-xni-_9aF1dsjj0w7V5UPMV5wv2GL8U",
    authDomain: "test-a7bac.firebaseapp.com",
    projectId: "test-a7bac",
    storageBucket: "test-a7bac.firebasestorage.app",
    messagingSenderId: "223746479746",
    appId: "1:223746479746:web:f55e01d30c558a17af469b"
};
firebase.initializeApp(firebaseConfig);
var db = firebase.firestore();

// Admin password (simple check)
var ADMIN_PASS = 'admin1234';

var allData = [];
var filteredData = [];

function adminLogin() {
    var pass = document.getElementById('adminPassword').value;
    if (pass === ADMIN_PASS) {
        document.getElementById('loginOverlay').style.display = 'none';
        document.getElementById('mainHeader').style.display = 'flex';
        document.getElementById('mainContent').style.display = 'block';
        sessionStorage.setItem('adminLoggedIn', 'true');
        loadData();
    } else {
        document.getElementById('loginError').style.display = 'block';
    }
}

function logout() {
    sessionStorage.removeItem('adminLoggedIn');
    location.reload();
}

// Type labels
var typeLabels = {
    notebook1: '‡∏á‡∏≤‡∏ô‡∏™‡∏°‡∏∏‡∏î 1',
    notebook2: '‡∏á‡∏≤‡∏ô‡∏™‡∏°‡∏∏‡∏î 2',
    notebook3: '‡∏á‡∏≤‡∏ô‡∏™‡∏°‡∏∏‡∏î 3',
    quiz1: '‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö ‡∏ö‡∏ó‡∏ó‡∏µ‡πà 1',
    quiz2: '‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö ‡∏ö‡∏ó‡∏ó‡∏µ‡πà 2',
    quiz3: '‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö ‡∏ö‡∏ó‡∏ó‡∏µ‡πà 3',
    message: '‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏∂‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏π'
};

async function loadData() {
    try {
        var snapshot = await db.collection('submissions').orderBy('timestamp', 'desc').get();
        allData = [];
        snapshot.forEach(function(doc) {
            allData.push({ id: doc.id, ...doc.data() });
        });
        updateStats();
        applyFilters();
    } catch(e) {
        console.error('Error loading data:', e);
    }
}

function updateStats() {
    document.getElementById('totalSubmissions').textContent = allData.length;
    document.getElementById('totalNotebook').textContent = allData.filter(function(d) { return d.type && d.type.startsWith('notebook'); }).length;
    document.getElementById('totalQuiz').textContent = allData.filter(function(d) { return d.type && d.type.startsWith('quiz'); }).length;
    document.getElementById('totalMessage').textContent = allData.filter(function(d) { return d.type === 'message'; }).length;
    document.getElementById('totalChecked').textContent = allData.filter(function(d) { return d.checked === true; }).length;
}

function applyFilters() {
    var cls = document.getElementById('filterClass').value;
    var type = document.getElementById('filterType').value;
    var name = document.getElementById('filterName').value.trim().toLowerCase();

    filteredData = allData.filter(function(d) {
        if (cls && d.classroom !== cls) return false;
        if (type && d.type !== type) return false;
        if (name && d.name && d.name.toLowerCase().indexOf(name) === -1) return false;
        return true;
    });

    // Sort by classroom then number
    filteredData.sort(function(a, b) {
        if (a.classroom !== b.classroom) return (a.classroom || '').localeCompare(b.classroom || '');
        return (a.number || 0) - (b.number || 0);
    });

    renderTable();
}

function switchClassTab(cls) {
    document.getElementById('filterClass').value = cls;
    document.querySelectorAll('.tab').forEach(function(t) { t.classList.remove('active'); });
    event.target.classList.add('active');
    applyFilters();
}

function renderTable() {
    var tbody = document.getElementById('dataTable');
    var emptyEl = document.getElementById('emptyState');

    if (filteredData.length === 0) {
        tbody.innerHTML = '';
        emptyEl.style.display = 'block';
        return;
    }

    emptyEl.style.display = 'none';
    var html = '';
    filteredData.forEach(function(d, i) {
        var dateStr = '';
        if (d.timestamp) {
            var dt = d.timestamp.toDate ? d.timestamp.toDate() : new Date(d.timestamp);
            dateStr = dt.toLocaleDateString('th-TH') + ' ' + dt.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
        }

        var contentCell = '';
        if (d.type && d.type.startsWith('quiz')) {
            var score = d.score || 0;
            var scoreClass = score >= 8 ? 'score-high' : (score >= 5 ? 'score-mid' : 'score-low');
            contentCell = '<span class="score-badge ' + scoreClass + '">' + score + '/10 (' + (score * 10) + '%)</span>';
        } else {
            var answer = d.answer || '';
            var shortAns = answer.length > 80 ? answer.substring(0, 80) + '...' : answer;
            contentCell = '<div class="answer-cell" onclick="showAnswer(' + i + ')">' + escapeHtml(shortAns) + '</div>';
        }

        html += '<tr>';
        html += '<td>' + (i + 1) + '</td>';
        html += '<td>' + escapeHtml(d.name || '-') + '</td>';
        html += '<td>' + escapeHtml(d.classroom || '-') + '</td>';
        html += '<td>' + (d.number || '-') + '</td>';
        html += '<td>' + (typeLabels[d.type] || d.type || '-') + '</td>';
        html += '<td>' + contentCell + '</td>';
        html += '<td>' + dateStr + '</td>';
        var isChecked = d.checked === true;
        html += '<td><button class="check-btn ' + (isChecked ? 'checked' : 'unchecked') + '" onclick="toggleChecked(\'' + d.id + '\',' + i + ')">' + (isChecked ? '‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß' : '‚¨ú ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏ß‡∏à') + '</button></td>';
        html += '</tr>';
    });
    tbody.innerHTML = html;
}

function escapeHtml(text) {
    var div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function showAnswer(index) {
    var d = filteredData[index];
    document.getElementById('modalTitle').textContent = (typeLabels[d.type] || d.type) + ' - ' + (d.name || '') + ' ' + (d.classroom || '') + ' ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ' + (d.number || '');
    document.getElementById('modalBody').textContent = d.answer || '-';
    document.getElementById('answerModal').classList.add('active');
}

function closeModal() {
    document.getElementById('answerModal').classList.remove('active');
}

async function toggleChecked(docId, index) {
    var d = filteredData[index];
    var newStatus = !d.checked;
    try {
        await db.collection('submissions').doc(docId).update({ checked: newStatus });
        // Update local data
        d.checked = newStatus;
        var item = allData.find(function(a) { return a.id === docId; });
        if (item) item.checked = newStatus;
        renderTable();
    } catch(e) {
        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + e.message);
    }
}

function exportCSV() {
    if (filteredData.length === 0) { alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ Export'); return; }

    var BOM = '\uFEFF';
    var csv = BOM + '‡∏•‡∏≥‡∏î‡∏±‡∏ö,‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•,‡∏´‡πâ‡∏≠‡∏á,‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà,‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô,‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö/‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô,‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡πà‡∏á,‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞\n';

    filteredData.forEach(function(d, i) {
        var dateStr = '';
        if (d.timestamp) {
            var dt = d.timestamp.toDate ? d.timestamp.toDate() : new Date(d.timestamp);
            dateStr = dt.toLocaleDateString('th-TH') + ' ' + dt.toLocaleTimeString('th-TH');
        }
        var content = '';
        if (d.type && d.type.startsWith('quiz')) {
            content = (d.score || 0) + '/10';
        } else {
            content = (d.answer || '').replace(/"/g, '""');
        }

        csv += (i + 1) + ',';
        csv += '"' + (d.name || '') + '",';
        csv += '"' + (d.classroom || '') + '",';
        csv += (d.number || '') + ',';
        csv += '"' + (typeLabels[d.type] || d.type || '') + '",';
        csv += '"' + content + '",';
        csv += '"' + dateStr + '",';
        csv += '"' + (d.checked ? '‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß' : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏ß‡∏à') + '"\n';
    });

    var blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    var link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'submissions_m5_' + new Date().toISOString().slice(0, 10) + '.csv';
    link.click();
}

// Check session
document.addEventListener('DOMContentLoaded', function() {
    if (sessionStorage.getItem('adminLoggedIn') === 'true') {
        document.getElementById('loginOverlay').style.display = 'none';
        document.getElementById('mainHeader').style.display = 'flex';
        document.getElementById('mainContent').style.display = 'block';
        loadData();
    }
});
</script>
</body>
</html>
